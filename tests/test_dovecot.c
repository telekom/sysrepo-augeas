/**
 * @file test_dovecot.c
 * @author Michal Vasko <mvasko@cesnet.cz>
 * @brief dovecot SR DS plugin test
 *
 * @copyright
 * Copyright (c) 2022 Deutsche Telekom AG.
 * Copyright (c) 2022 CESNET, z.s.p.o.
 *
 * This source code is licensed under BSD 3-Clause License (the "License").
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://opensource.org/licenses/BSD-3-Clause
 */

#include "tconfig.h"

/* augeas SR DS plugin */
#define AUG_TEST_INPUT_FILES AUG_CONFIG_FILES_DIR "/dovecot"
#include "srds_augeas.c"
#include "srdsa_init.c"
#include "srdsa_load.c"
#include "srdsa_store.c"
#include "srdsa_common.c"

#include <assert.h>
#include <dlfcn.h>
#include <setjmp.h>
#include <stdarg.h>
#include <unistd.h>

#include <cmocka.h>
#include <libyang/libyang.h>
#include <sysrepo/plugins_datastore.h>

#define AUG_TEST_MODULE "dovecot"

static int
setup_f(void **state)
{
    return tsetup_glob(state, AUG_TEST_MODULE, &srpds__, AUG_TEST_INPUT_FILES);
}

static void
test_load(void **state)
{
    struct tstate *st = (struct tstate *)*state;
    char *str;

    assert_int_equal(SR_ERR_OK, st->ds_plg->load_cb(st->mod, SR_DS_STARTUP, NULL, 0, &st->data));
    lyd_print_mem(&str, st->data, LYD_XML, LYD_PRINT_WITHSIBLINGS);

    assert_string_equal(str,
            "<" AUG_TEST_MODULE " xmlns=\"aug:" AUG_TEST_MODULE "\">\n"
            "  <config-file>" AUG_CONFIG_FILES_DIR "/" AUG_TEST_MODULE "</config-file>\n"
            "  <config-entries>\n"
            "    <_id>1</_id>\n"
            "    <entry>\n"
            "      <keys>disable_plaintext_auth</keys>\n"
            "      <value>yes</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>2</_id>\n"
            "    <entry>\n"
            "      <keys>auth_cache_size</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>3</_id>\n"
            "    <entry>\n"
            "      <keys>auth_cache_ttl</keys>\n"
            "      <value>1 hour</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>4</_id>\n"
            "    <entry>\n"
            "      <keys>auth_cache_negative_ttl</keys>\n"
            "      <value>1 hour</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>5</_id>\n"
            "    <entry>\n"
            "      <keys>auth_realms</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>6</_id>\n"
            "    <entry>\n"
            "      <keys>auth_default_realm</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>7</_id>\n"
            "    <entry>\n"
            "      <keys>auth_username_chars</keys>\n"
            "      <value>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890.-_@</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>8</_id>\n"
            "    <entry>\n"
            "      <keys>auth_username_translation</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>9</_id>\n"
            "    <entry>\n"
            "      <keys>auth_username_format</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>10</_id>\n"
            "    <entry>\n"
            "      <keys>auth_master_user_separator</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>11</_id>\n"
            "    <entry>\n"
            "      <keys>auth_anonymous_username</keys>\n"
            "      <value>anonymous</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>12</_id>\n"
            "    <entry>\n"
            "      <keys>auth_worker_max_count</keys>\n"
            "      <value>30</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>13</_id>\n"
            "    <entry>\n"
            "      <keys>auth_gssapi_hostname</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>14</_id>\n"
            "    <entry>\n"
            "      <keys>auth_krb5_keytab</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>15</_id>\n"
            "    <entry>\n"
            "      <keys>auth_use_winbind</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>16</_id>\n"
            "    <entry>\n"
            "      <keys>auth_winbind_helper_path</keys>\n"
            "      <value>/usr/bin/ntlm_auth</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>17</_id>\n"
            "    <entry>\n"
            "      <keys>auth_failure_delay</keys>\n"
            "      <value>2 secs</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>18</_id>\n"
            "    <entry>\n"
            "      <keys>auth_ssl_require_client_cert</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>19</_id>\n"
            "    <entry>\n"
            "      <keys>auth_ssl_username_from_cert</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>20</_id>\n"
            "    <entry>\n"
            "      <keys>auth_mechanisms</keys>\n"
            "      <value>plain</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>21</_id>\n"
            "    <include>auth-deny.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>22</_id>\n"
            "    <include>auth-master.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>23</_id>\n"
            "    <include>auth-system.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>24</_id>\n"
            "    <include>auth-sql.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>25</_id>\n"
            "    <include>auth-ldap.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>26</_id>\n"
            "    <include>auth-passwdfile.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>27</_id>\n"
            "    <include>auth-checkpassword.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>28</_id>\n"
            "    <include>auth-vpopmail.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>29</_id>\n"
            "    <include>auth-static.conf.ext</include>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>30</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <passdb>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>driver</keys>\n"
            "            <value>passwd-file</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>deny</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>args</keys>\n"
            "            <value>/etc/dovecot/deny-users</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </passdb>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>31</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <passdb>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>driver</keys>\n"
            "            <value>passwd-file</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>master</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>args</keys>\n"
            "            <value>/etc/dovecot/master-users</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <entry>\n"
            "            <keys>pass</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </passdb>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>32</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <userdb>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>driver</keys>\n"
            "            <value>passwd-file</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>args</keys>\n"
            "            <value>username_format=%u /etc/dovecot/users</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </userdb>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>33</_id>\n"
            "    <entry>\n"
            "      <keys>default_process_limit</keys>\n"
            "      <value>100</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>34</_id>\n"
            "    <entry>\n"
            "      <keys>default_client_limit</keys>\n"
            "      <value>1000</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>35</_id>\n"
            "    <entry>\n"
            "      <keys>default_vsz_limit</keys>\n"
            "      <value>256M</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>36</_id>\n"
            "    <entry>\n"
            "      <keys>default_login_user</keys>\n"
            "      <value>dovenull</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>37</_id>\n"
            "    <entry>\n"
            "      <keys>default_internal_user</keys>\n"
            "      <value>dovecot</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>38</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>imap-login</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <_dict-ref>3</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>service_count</keys>\n"
            "            <value>1</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <entry>\n"
            "            <keys>process_min_avail</keys>\n"
            "            <value>0</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>5</_id>\n"
            "          <entry>\n"
            "            <keys>vsz_limit</keys>\n"
            "            <value>64M</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <inet-listener>\n"
            "        <value>imap</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>port</keys>\n"
            "            <value>143</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </inet-listener>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>3</_r-id>\n"
            "      <inet-listener>\n"
            "        <value>imaps</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>port</keys>\n"
            "            <value>993</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>ssl</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </inet-listener>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>39</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>pop3-login</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <_dict-ref>3</_dict-ref>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <inet-listener>\n"
            "        <value>pop3</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>port</keys>\n"
            "            <value>110</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </inet-listener>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>3</_r-id>\n"
            "      <inet-listener>\n"
            "        <value>pop3s</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>port</keys>\n"
            "            <value>995</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>ssl</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </inet-listener>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>40</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>lmtp</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <_dict-ref>3</_dict-ref>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <unix-listener>\n"
            "        <value>lmtp</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>mode</keys>\n"
            "            <value>0666</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </unix-listener>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>3</_r-id>\n"
            "      <inet-listener>\n"
            "        <value>lmtp</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>address</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>port</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </inet-listener>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>41</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>imap</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>vsz_limit</keys>\n"
            "            <value>256M</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>process_limit</keys>\n"
            "            <value>1024</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>42</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>auth</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <unix-listener>\n"
            "        <value>auth-userdb</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>mode</keys>\n"
            "            <value>0600</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>user</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>group</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </unix-listener>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>43</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>auth-worker</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>user</keys>\n"
            "            <value>root</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>44</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>dict</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <unix-listener>\n"
            "        <value>dict</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>mode</keys>\n"
            "            <value>0600</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>user</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>group</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </unix-listener>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>45</_id>\n"
            "    <entry>\n"
            "      <keys>director_servers</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>46</_id>\n"
            "    <entry>\n"
            "      <keys>director_mail_servers</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>47</_id>\n"
            "    <entry>\n"
            "      <keys>director_user_expire</keys>\n"
            "      <value>15 min</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>48</_id>\n"
            "    <entry>\n"
            "      <keys>director_doveadm_port</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>49</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>director</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <_dict-ref>3</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <_dict-ref>4</_dict-ref>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <_dict-ref>5</_dict-ref>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <unix-listener>\n"
            "        <value>login/director</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>mode</keys>\n"
            "            <value>0666</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </unix-listener>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>3</_r-id>\n"
            "      <fifo-listener>\n"
            "        <value>login/proxy-notify</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>mode</keys>\n"
            "            <value>0666</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </fifo-listener>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>4</_r-id>\n"
            "      <unix-listener>\n"
            "        <value>director-userdb</value>\n"
            "      </unix-listener>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>5</_r-id>\n"
            "      <inet-listener>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>port</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </inet-listener>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>50</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>imap-login</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>executable</keys>\n"
            "            <value>imap-login director</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>51</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <service>\n"
            "        <value>pop3-login</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>executable</keys>\n"
            "            <value>pop3-login director</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </service>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>52</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <protocol>\n"
            "        <value>lmtp</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>auth_socket_path</keys>\n"
            "            <value>director-userdb</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </protocol>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>53</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <map>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>pattern</keys>\n"
            "            <value>priv/quota/storage</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>table</keys>\n"
            "            <value>quota</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>username_field</keys>\n"
            "            <value>username</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <entry>\n"
            "            <keys>value_field</keys>\n"
            "            <value>bytes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </map>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>54</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <map>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>pattern</keys>\n"
            "            <value>priv/quota/messages</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>table</keys>\n"
            "            <value>quota</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>username_field</keys>\n"
            "            <value>username</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <entry>\n"
            "            <keys>value_field</keys>\n"
            "            <value>messages</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </map>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>55</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <map>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>pattern</keys>\n"
            "            <value>shared/expire/$user/$mailbox</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>table</keys>\n"
            "            <value>expires</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>value_field</keys>\n"
            "            <value>expire_stamp</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <_dict-ref>2</_dict-ref>\n"
            "        </config-entries>\n"
            "      </map>\n"
            "    </dict-list>\n"
            "    <dict-list>\n"
            "      <_r-id>2</_r-id>\n"
            "      <fields>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>username</keys>\n"
            "            <value>$user</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>mailbox</keys>\n"
            "            <value>$mailbox</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </fields>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>56</_id>\n"
            "    <entry>\n"
            "      <keys>mail_location</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>57</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <namespace>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>type</keys>\n"
            "            <value>private</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>separator</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>prefix</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <entry>\n"
            "            <keys>location</keys>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>5</_id>\n"
            "          <entry>\n"
            "            <keys>inbox</keys>\n"
            "            <value>no</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>6</_id>\n"
            "          <entry>\n"
            "            <keys>hidden</keys>\n"
            "            <value>no</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>7</_id>\n"
            "          <entry>\n"
            "            <keys>list</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>8</_id>\n"
            "          <entry>\n"
            "            <keys>subscriptions</keys>\n"
            "            <value>yes</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            /*"        <config-entries>\n"   - should match as "mailbox" instead of "entry" but Augeas deletes '='
            "          <_id>9</_id>\n"         that decides it
            "          <entry>\n"
            "            <keys>mailbox</keys>\n"
            "            <value>Sent Messages</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"*/
            "      </namespace>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>58</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <namespace>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>type</keys>\n"
            "            <value>shared</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>2</_id>\n"
            "          <entry>\n"
            "            <keys>separator</keys>\n"
            "            <value>/</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>3</_id>\n"
            "          <entry>\n"
            "            <keys>prefix</keys>\n"
            "            <value>shared/%%u/</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>4</_id>\n"
            "          <entry>\n"
            "            <keys>location</keys>\n"
            "            <value>maildir:%%h/Maildir:INDEX=~/Maildir/shared/%%u</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>5</_id>\n"
            "          <entry>\n"
            "            <keys>subscriptions</keys>\n"
            "            <value>no</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "        <config-entries>\n"
            "          <_id>6</_id>\n"
            "          <entry>\n"
            "            <keys>list</keys>\n"
            "            <value>children</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </namespace>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>59</_id>\n"
            "    <entry>\n"
            "      <keys>mail_uid</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>60</_id>\n"
            "    <entry>\n"
            "      <keys>mail_gid</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>61</_id>\n"
            "    <entry>\n"
            "      <keys>mail_privileged_group</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>62</_id>\n"
            "    <entry>\n"
            "      <keys>mail_access_groups</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>63</_id>\n"
            "    <entry>\n"
            "      <keys>mail_full_filesystem_access</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>64</_id>\n"
            "    <entry>\n"
            "      <keys>mmap_disable</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>65</_id>\n"
            "    <entry>\n"
            "      <keys>dotlock_use_excl</keys>\n"
            "      <value>yes</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>66</_id>\n"
            "    <entry>\n"
            "      <keys>mail_fsync</keys>\n"
            "      <value>optimized</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>67</_id>\n"
            "    <entry>\n"
            "      <keys>mail_nfs_storage</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>68</_id>\n"
            "    <entry>\n"
            "      <keys>mail_nfs_index</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>69</_id>\n"
            "    <entry>\n"
            "      <keys>lock_method</keys>\n"
            "      <value>fcntl</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>70</_id>\n"
            "    <entry>\n"
            "      <keys>mail_temp_dir</keys>\n"
            "      <value>/tmp</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>71</_id>\n"
            "    <entry>\n"
            "      <keys>first_valid_uid</keys>\n"
            "      <value>500</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>72</_id>\n"
            "    <entry>\n"
            "      <keys>last_valid_uid</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>73</_id>\n"
            "    <entry>\n"
            "      <keys>first_valid_gid</keys>\n"
            "      <value>1</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>74</_id>\n"
            "    <entry>\n"
            "      <keys>last_valid_gid</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>75</_id>\n"
            "    <entry>\n"
            "      <keys>mail_max_keyword_length</keys>\n"
            "      <value>50</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>76</_id>\n"
            "    <entry>\n"
            "      <keys>valid_chroot_dirs</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>77</_id>\n"
            "    <entry>\n"
            "      <keys>mail_chroot</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>78</_id>\n"
            "    <entry>\n"
            "      <keys>auth_socket_path</keys>\n"
            "      <value>/var/run/dovecot/auth-userdb</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>79</_id>\n"
            "    <entry>\n"
            "      <keys>mail_plugin_dir</keys>\n"
            "      <value>/usr/lib/dovecot/modules</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>80</_id>\n"
            "    <entry>\n"
            "      <keys>mail_plugins</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>81</_id>\n"
            "    <entry>\n"
            "      <keys>mail_cache_min_mail_count</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>82</_id>\n"
            "    <entry>\n"
            "      <keys>mailbox_idle_check_interval</keys>\n"
            "      <value>30 secs</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>83</_id>\n"
            "    <entry>\n"
            "      <keys>mail_save_crlf</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>84</_id>\n"
            "    <entry>\n"
            "      <keys>maildir_stat_dirs</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>85</_id>\n"
            "    <entry>\n"
            "      <keys>maildir_copy_with_hardlinks</keys>\n"
            "      <value>yes</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>86</_id>\n"
            "    <entry>\n"
            "      <keys>maildir_very_dirty_syncs</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>87</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_read_locks</keys>\n"
            "      <value>fcntl</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>88</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_write_locks</keys>\n"
            "      <value>dotlock fcntl</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>89</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_lock_timeout</keys>\n"
            "      <value>5 mins</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>90</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_dotlock_change_timeout</keys>\n"
            "      <value>2 mins</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>91</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_dirty_syncs</keys>\n"
            "      <value>yes</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>92</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_very_dirty_syncs</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>93</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_lazy_writes</keys>\n"
            "      <value>yes</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>94</_id>\n"
            "    <entry>\n"
            "      <keys>mbox_min_index_size</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>95</_id>\n"
            "    <entry>\n"
            "      <keys>mdbox_rotate_size</keys>\n"
            "      <value>2M</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>96</_id>\n"
            "    <entry>\n"
            "      <keys>mdbox_rotate_interval</keys>\n"
            "      <value>0</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>97</_id>\n"
            "    <entry>\n"
            "      <keys>mdbox_preallocate_space</keys>\n"
            "      <value>no</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>98</_id>\n"
            "    <entry>\n"
            "      <keys>mail_attachment_dir</keys>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>99</_id>\n"
            "    <entry>\n"
            "      <keys>mail_attachment_min_size</keys>\n"
            "      <value>128k</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>100</_id>\n"
            "    <entry>\n"
            "      <keys>mail_attachment_fs</keys>\n"
            "      <value>sis posix</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>101</_id>\n"
            "    <entry>\n"
            "      <keys>mail_attachment_hash</keys>\n"
            "      <value>%{sha1}</value>\n"
            "    </entry>\n"
            "  </config-entries>\n"
            "  <config-entries>\n"
            "    <_id>102</_id>\n"
            "    <dict-list>\n"
            "      <_r-id>1</_r-id>\n"
            "      <protocol>\n"
            "        <value>!indexer-worker</value>\n"
            "        <config-entries>\n"
            "          <_id>1</_id>\n"
            "          <entry>\n"
            "            <keys>mail_vsize_bg_after_count</keys>\n"
            "            <value>0</value>\n"
            "          </entry>\n"
            "        </config-entries>\n"
            "      </protocol>\n"
            "    </dict-list>\n"
            "  </config-entries>\n"
            "</" AUG_TEST_MODULE ">\n");
    free(str);
}

int
main(void)
{
    const struct CMUnitTest tests[] = {
        cmocka_unit_test_teardown(test_load, tteardown),
    };

    return cmocka_run_group_tests(tests, setup_f, tteardown_glob);
}
